/*
 * GCB profile - UNC Longleaf cluster configuration
 */

env {
    RESOURCE_DIR = "/workspace/References"
    ANALYSES_DIR = "${params.project_dir}/analyses"
    GENOTYPES_DIR = "${params.project_dir}/genotypes"
}

workDir = "${params.project_dir}/work"
cleanup = false

process {
    executor = 'slurm'
    queue = 'general'
    container = 'ghcr.io/hirotaka-i/long-gwas-pipeline:latest'
    containerOptions = "-v ${params.reference_dir}:/workspace/References"
    errorStrategy = { task.exitStatus==14 ? 'retry' : 'terminate' }
    maxRetries = 5
    
    beforeScript = '''
        echo "=== Task Environment ===" >&2
        echo "Task started: $(date)" >&2
        echo "Hostname: $(hostname)" >&2
        echo "CPUs: $(nproc)" >&2
        echo "Memory: $(free -h | awk '/^Mem:/ {print $7 " available of " $2}')" >&2
        echo "Disk: $(df -h . | tail -1 | awk '{print $4 " available of " $2}')" >&2
        echo "======================" >&2
    '''.stripIndent()
    
    afterScript = '''
        EXIT_CODE=$?
        echo "=== Task Completion ===" >&2
        echo "Task finished: $(date)" >&2
        echo "Exit code: $EXIT_CODE" >&2
        echo "Memory used: $(free -h | awk '/^Mem:/ {print $3}')" >&2
        echo "======================" >&2
        exit $EXIT_CODE
    '''.stripIndent()
    
    withLabel: small {
        cpus = 2
        memory = '4 GB'
        time = '2h'
    }
    
    withLabel: medium {
        cpus = 4
        memory = '8 GB'
        time = '4h'
    }
    
    withLabel: large {
        cpus = 8
        memory = '16 GB'
        time = '8h'
    }
    
    withLabel: very_large {
        cpus = 16
        memory = '256 GB'
        time = '12h'
    }

    withLabel: two_cpu_large_mem {
        cpus = 2
        memory = '128 GB'
        time = '2h'
    }
}

executor {
    queueSize = 200
    submitRateLimit = '10 sec'
}

singularity {
    enabled = true
    autoMounts = true
    cacheDir = '/work/users/$USER/singularity_cache'
}

google {
    region = 'europe-west4'
    project = "${GOOGLE_CLOUD_PROJECT}"
    batch.serviceAccountEmail = "${GOOGLE_SERVICE_ACCOUNT_EMAIL}"
    batch.usePrivateAddress = true
    batch.network = 'global/networks/network'
    batch.subnetwork = "regions/europe-west4/subnetworks/subnetwork"
    batch.bootDiskSize = '50 GB'
    batch.allowedLocations = ['zones/europe-west4-a', 'zones/europe-west4-b']
}
